'use strict';

angular.module('app', [
  'angularUtils.directives.dirPagination'
]); 
angular.module('app').controller('FeedCtrl', ['$scope', 'InstagramService', 'VKService', function($scope, InstagramService, VKService) {

  InstagramService.getImages(function(posts) {
    $scope.posts = [];

    for (var i = 0; i < posts.length; i++) {
      $scope.posts.push({
        image: posts[i].images.thumbnail.url,
        link: posts[i].lisk,
        date: posts[i].created_time
      });
    }
  });
  
}]);
angular.module('app').controller('MainCtrl', ['$scope', '$location', '$sce', function($scope, $location, $sce) {

  $scope.trustSrc = function(src) {
    return $sce.trustAsResourceUrl(src);
  };

  $scope.currentPage = $location.absUrl().match(/\/([\W\D]*)$/)[0];
  
}]);
angular.module('app').controller('PhotoListCtrl', ['$scope', 'PhotoService', function($scope, PhotoService) {

  PhotoService.getAll(function(response) {
    $scope.photos = response;
  });
  
}]);
angular.module('app').controller('ProjectListCtrl', ['$scope', 'ProjectService', function($scope, ProjectService) {

  ProjectService.getAll(function(projects) {
    $scope.projects = projects;
  });
  
}]);
angular.module('app').controller('VideoListCtrl', ['$scope', 'VideoService', function($scope, VideoService) {

  VideoService.getAll(function(videos) {
    $scope.videos = videos;
    console.log(videos);
  });
  
}]);
angular.module('app').directive('bxSlider', function() {
  return {
    restrict: 'A',
    link: function (scope, element, attrs) {
      console.log('test');
      scope.$on('repeatFinished', function () {
        element.bxSlider(scope.$eval('{' + attrs.bxSlider + '}'));
      });
    }
  }
}).directive('repeatFinished', ['$timeout', function ($timeout) {
  return {
    restrict: 'A',
    link: function (scope, element, attr) {
      if (scope.$last === true) {
        $timeout(function () {
          scope.$emit('repeatFinished');
        });
      }
    }
  }
}]);
angular.module('app').directive('preview', function() {
  return {
    restrict: 'AEC',
    template: 
      '<img ng-src="{{photo.preview_url}}" class="b-preview__photo">' +
      '<div class="b-preview__actions">' +
        '<a href="{{photo.url}}" class="b-preview__actions__zoom"></a>' + 
        '<a href="{{photo.url}}" class="b-preview__actions__src"></a>' + 
      '</div>',

    scope: {
      photo: '='
    },

    link: function(scope, element, attrs) {
    }
  };
});
angular.module('app').factory('InstagramService', ['$http', function($http) {
  var apiUrl = 'https://api.instagram.com/v1/users/self/feed?access_token=391150608.1fb234f.fe6306c9ddcc4ad99e370bf5b4b20170';

  return {
    getImages: function(callback) {
            
      $http.jsonp('https://api.instagram.com/v1/media/popular?count=2&client_id=642176ece1e7445e99244cec26f4de1f&callback=JSON_CALLBACK').success(function(response){
          callback(response.data);
      });
    }
  }
}]);
angular.module('app').factory('PhotoService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/photos.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);
angular.module('app').factory('ProjectService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/projects.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);
angular.module('app').factory('VKService', ['$http', function($http) {
  return {
    all: function () {
      return $http.get('/api/photos.json');
    }
  }
}]);
angular.module('app').factory('VideoService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/videos.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);