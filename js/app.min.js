'use strict';

angular.module('app', [
  'angularUtils.directives.dirPagination'
]); 

angular.module('app').config(function($sceDelegateProvider) {
  $sceDelegateProvider.resourceUrlWhitelist([
    // Allow same origin resource loads.
    'self',
    // Allow loading from our assets domain.  Notice the difference between * and **.
    'http://*.youtube.com/**'
  ]);
})
angular.module('app').controller('FeedCtrl', ['$scope', 'InstagramService', 'VKService', function($scope, InstagramService, VKService) {

  var VKOwnerId = 126216471;

  $scope.posts = [];

  VKService.getPosts({ owner_id: VKOwnerId, count: 2, filter: 'owner'}, function(posts) {
    
    console.log(posts);
    for (var i = 1; i < posts.length; i++) {
      $scope.posts.push({
        image: posts[i].attachment.photo ? posts[i].attachment.photo.src_big : '',
        link: 'http://vk.com/wall' + VKOwnerId + '_' + posts[i].id,
        desc: posts[i].text,
        date: posts[i].date
      });
    }

  });

  InstagramService.getPosts({ count: 2 }, function(posts) {
    for (var i = 0; i < posts.length; i++) {
      $scope.posts.push({
        image: posts[i].images.thumbnail.url,
        link: posts[i].link,
        desc: posts[i].caption.text ? posts[i].caption.text : '',
        date: posts[i].created_time
      });
    }
  });
  
}]);
angular.module('app').controller('MainCtrl', ['$scope', '$location', '$sce', function($scope, $location, $sce) {

  $scope.trustSrc = function(src) {
    return $sce.trustAsResourceUrl(src);
  };

  $scope.currentPage = $location.absUrl().match(/\/([\W\D]*)$/)[0];
  
}]);
angular.module('app').controller('PhotoListCtrl', ['$scope', 'PhotoService', function($scope, PhotoService) {

  PhotoService.getAll(function(response) {
    $scope.photos = response;
  });
  
}]);
angular.module('app').controller('ProjectListCtrl', ['$scope', 'ProjectService', function($scope, ProjectService) {

  ProjectService.getAll(function(projects) {
    $scope.projects = projects;
  });
  
}]);
angular.module('app').controller('VideoListCtrl', ['$scope', 'VideoService', function($scope, VideoService) {

  VideoService.getAll(function(videos) {
    $scope.videos = videos;
    console.log(videos);
  });
  
}]);
angular.module('app').directive('bxSlider', function() {
  return {
    restrict: 'A',
    link: function (scope, element, attrs) {
      console.log('test');
      scope.$on('repeatFinished', function () {
        element.bxSlider(scope.$eval('{' + attrs.bxSlider + '}'));
      });
    }
  }
}).directive('repeatFinished', ['$timeout', function ($timeout) {
  return {
    restrict: 'A',
    link: function (scope, element, attr) {
      if (scope.$last === true) {
        $timeout(function () {
          scope.$emit('repeatFinished');
        });
      }
    }
  }
}]);
angular.module('app').directive('preview', function() {
  return {
    restrict: 'AEC',
    template: 
      '<img ng-src="{{photo.preview_url}}" class="b-preview__photo">' +
      '<div class="b-preview__actions">' +
        '<a href="{{photo.url}}" class="b-preview__actions__zoom js-fancybox"></a>' + 
        //'<a href="{{photo.url}}" class="b-preview__actions__src"></a>' + 
      '</div>',

    scope: {
      photo: '='
    },

    link: function(scope, element, attrs) {
    }
  };
});
angular.module('app').directive('videoSlider', function() {
  return {
    restrict: 'AEC',
    template: 
      '<div class="b-video-slider">' +
        '<ul class="b-video-slider__items" bx-slider="slideWidth: 300, slideMargin: 20, maxSlides: 3, pager: false, prevText: \'\', nextText: \'\'">' +
          '<li class="b-video-slider__item" ng-repeat="video in videos | limitTo:limit" repeat-finished>' +
            '<iframe width="300" height="200" ng-src="{{video.url}}" frameborder="0" allowfullscreen>' + 
          '</li>' +
        '</ul>' +
      '</div>',

    scope: {
      videos: '=',
      limit: '='
    },

    link: function(scope, element, attrs) {

    }
  };
});
angular.module('app').filter('cut', function() {
  return function (value, wordwise, max, tail) {
    if (!value) return '';

    max = parseInt(max, 10);
    if (!max) return value;
    if (value.length <= max) return value;

    value = value.substr(0, max);
    if (wordwise) {
      var lastspace = value.lastIndexOf(' ');
      if (lastspace != -1) {
        value = value.substr(0, lastspace);
      }
    }

    return value + (tail || ' â€¦');
  };
});
angular.module('app').factory('InstagramService', ['$http', function($http) {
  var apiUrl = 'https://api.instagram.com/v1/users/self/feed?access_token=391150608.1fb234f.fe6306c9ddcc4ad99e370bf5b4b20170';

  return {
    getPosts: function(params, callback) {
            
      $http.jsonp('https://api.instagram.com/v1/media/popular?count=' + params.count + '&client_id=642176ece1e7445e99244cec26f4de1f&callback=JSON_CALLBACK').success(function(response){
          callback(response.data);
      });
    }
  }
}]);
angular.module('app').factory('PhotoService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/photos.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);
angular.module('app').factory('ProjectService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/projects.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);
angular.module('app').factory('VKService', ['$http', function($http) {
  return {
    getPosts: function(params, callback) {
      VK.Api.call('wall.get', params, function(r) { 
        if (r.response) { 
          callback(r.response); 
        } 
      }); 
    }
  }
}]);
angular.module('app').factory('VideoService', ['$http', function($http) {
  return {
    getAll: function(callback) {
      return $http.get('/api/videos.json').success(function(response) {
        callback(response);
      });
    }
  }
}]);